<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Checkout - An's Toy Store</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="assets/css/style.css">
    <script src="assets/js/site.js"></script>
</head>
<body class="with-sticky-footer">
<header>
    <div class="header-container">
        <div class="logo" id="logo">AN TOY'S STORE</div>
        <div style="flex:1"></div>
        <div class="search-bar">
            <input type="text" id="siteSearchInput" placeholder="Search for products..." autocomplete="off">
            <div id="siteSearchResults" class="search-results" style="display:none;"></div>
        </div>
        <button class="hamburger-menu">
            <span></span>
            <span></span>
            <span></span>
        </button>
        <nav>
            <ul>
                <li><a href="Trangchu_en.html">Home</a></li>
                <li><a href="TatcaSanpham_en.html">Products</a></li>
                <li><a href="Gioithieu_en.html">About</a></li>
            </ul>
        </nav>
        <div class="language-selector">
            <select id="languageSelect">
                <option value="vi">Ti·∫øng Vi·ªát</option>
                <option value="en" selected>English</option>
            </select>
        </div>
        <div class="auth-wrap">
            <div class="auth-icon" id="authIcon"></div>
            <div class="auth-popup" id="authPopup"></div>
        </div>
        <div class="cart-icon" id="cartIcon">üõí</div>
    </div>
</header>

<main style="max-width:1100px;margin:100px auto;padding:0 1rem;">
    <div class="page-grid">
        <div class="page-main">
            <h1>Checkout</h1>
            <div id="checkoutArea">Loading...</div>
        </div>
        <aside class="page-aside">
            <div class="summary-card" id="checkoutSummary">
                <div class="summary-title">Payment Details</div>
                <div class="summary-amount">$0</div>
                <div class="summary-actions"><button class="btn btn-primary" id="placeOrderBtn">Place Order</button></div>
            </div>
        </aside>
    </div>
</main>

<footer>
    <div class="footer-content">
        <div class="footer-section">
            <h4>V·ªÅ An's Toys Store</h4>
            <ul>
                <li><a href="Gioithieu.html">Gi·ªõi thi·ªáu</a></li>
                <li><a href="#">Ch√≠nh s√°ch</a></li>
            </ul>
        </div>
        <div class="footer-section">
            <h4>H·ªó tr·ª£</h4>
            <ul>
                <li><a href="#">H∆∞·ªõng d·∫´n mua h√†ng</a></li>
                <li><a href="#">Returns</a></li>
                <li><a href="#">Li√™n h·ªá</a></li>
            </ul>
        </div>
        <div class="footer-section">
            <h4>Theo d√µi</h4>
            <ul>
                <li><a href="#">Facebook</a></li>
                <li><a href="#">Instagram</a></li>
                <li><a href="#">TikTok</a></li>
            </ul>
        </div>
    </div>
</footer>

<script>
// Checkout page: render form + summary, coupon, validation, and order persistence
;(function(){
    var coupons = {
        'GIAM10': { type: 'percent', value: 10 },
        'GIAM50K': { type: 'fixed', value: 50000 }
    };
    var appliedCoupon = null;

    function formatUSD(n){ return '$' + ((n||0)/26306).toFixed(2); }

    function getCheckoutItems(){
        var items = JSON.parse(localStorage.getItem('checkoutCart') || '[]');
        if (!items || items.length===0) items = (window.SITE && SITE.getCart) ? SITE.getCart() : JSON.parse(localStorage.getItem('cartItems')||'[]');
        return items || [];
    }

    function renderCheckout(){
        var items = getCheckoutItems();
        var area = document.getElementById('checkoutArea');
        if (!items || items.length === 0){
            area.innerHTML = '<div class="empty-card"><p style="text-align:center;padding:48px 16px">No products to checkout. <a href="TatcaSanpham_en.html">Back to shopping</a></p></div>';
            updateSummary(0,0);
            return;
        }

        var leftHtml = '';
        // Customer info
        leftHtml += '<div class="checkout-card"><h3>Customer info</h3>'+
            '<div style="display:flex;gap:12px;margin-top:12px;flex-wrap:wrap">'
            + '<input id="customerName" placeholder="Customer name *" style="flex:1 1 300px;padding:12px;border-radius:8px;border:1px solid #e6e6e6">'
            + '<input id="customerPhone" placeholder="Phone Number *" style="flex:0 0 260px;padding:12px;border-radius:8px;border:1px solid #e6e6e6">'
            + '</div></div>';

        // Address
        leftHtml += '<div class="checkout-card" style="margin-top:16px"><h3>Delivery method</h3>'+
            '<div style="display:flex;gap:12px;margin-top:12px;flex-wrap:wrap">'
            + '<div style="flex:1 1 48%"><input id="cityInput" list="cityDatalist" placeholder="Province/City *" style="width:100%;padding:12px;border-radius:8px;border:1px solid #e6e6e6">'
            + '<datalist id="cityDatalist"><option value="H√† N·ªôi"><option value="H·ªì Ch√≠ Minh"></datalist></div>'
            + '<div style="flex:1 1 48%"><input id="wardInput" list="wardDatalist" placeholder="Ward/Commune *" style="width:100%;padding:12px;border-radius:8px;border:1px solid #e6e6e6">'
            + '<datalist id="wardDatalist"></datalist></div>'
            + '</div>'
            + '<div style="margin-top:12px"><input id="addressInput" placeholder="Delivery Address *" style="width:100%;padding:12px;border-radius:8px;border:1px solid #e6e6e6"></div>'
            + '</div>';

        // Product list
        leftHtml += '<div class="checkout-card" style="margin-top:16px"><h3>Products ('+items.length+')</h3>';
        leftHtml += '<table style="width:100%;border-collapse:collapse;margin-top:12px"><thead><tr><th style="text-align:left;padding:12px">Product</th><th style="padding:12px">Unit Price</th><th style="padding:12px">Quantity</th><th style="padding:12px">Total</th></tr></thead><tbody>';
        var subtotal = 0;
        items.forEach(function(it){
            var qty = it.qty || it.quantity || 1;
            var line = (it.price||0) * qty; subtotal += line;
            leftHtml += '<tr><td style="padding:12px">'+(it.img?('<img src="'+it.img+'" style="width:56px;height:56px;object-fit:cover;margin-right:8px;vertical-align:middle">'):'')+' <strong>'+it.name+'</strong></td>';
            leftHtml += '<td style="padding:12px">'+formatUSD(it.price)+'</td>';
            leftHtml += '<td style="padding:12px">x'+qty+'</td>';
            leftHtml += '<td style="padding:12px">'+formatUSD(line)+'</td></tr>';
        });
        leftHtml += '</tbody></table></div>';

        // Payment methods
        leftHtml += '<div class="checkout-card" style="margin-top:16px"><h3>Payment Method</h3>'+
            '<div style="margin-top:12px">'
            + '<label style="display:block;margin-bottom:8px"><input type="radio" name="payMethod" value="cod" checked> Cash on Delivery</label>'
            + '<label style="display:block;margin-bottom:8px"><input type="radio" name="payMethod" value="bank"> Bank transfer via QR code</label>'
            + '</div></div>';

        // Order note & coupon
        leftHtml += '<div style="display:flex;gap:16px;flex-wrap:wrap;margin-top:16px">';
        leftHtml += '<div class="checkout-card" style="flex:1 1 60%"><h3>Order Notes</h3><textarea id="orderNote" placeholder="Add note (optional)" style="width:100%;min-height:120px;padding:12px;border-radius:8px;border:1px solid #e6e6e6"></textarea></div>';
        leftHtml += '<div style="flex:1 1 35%"><div class="checkout-card"><h3>Promotions</h3><div style="display:flex;gap:8px;margin-top:12px"><input id="couponCode" placeholder="Enter promo code" style="flex:1;padding:10px;border-radius:6px;border:1px solid #e6e6e6"><button id="applyCouponBtn" class="btn" style="padding:10px 12px">Apply</button></div><div id="couponMsg" style="margin-top:8px;color:#d9534f"></div></div></div>';
        leftHtml += '</div>';

        area.innerHTML = leftHtml;

        // populate city/ward simple mapping and wire editable inputs
        var wards = {
            'H√† N·ªôi': ['Ho√†n Ki·∫øm','Ba ƒê√¨nh','ƒê·ªëng ƒêa'],
            'H·ªì Ch√≠ Minh': ['Qu·∫≠n 1','Qu·∫≠n 3','Qu·∫≠n 7']
        };
        var cityInput = document.getElementById('cityInput');
        var wardInput = document.getElementById('wardInput');
        var wardDatalist = document.getElementById('wardDatalist');
        // when city input changes (user types or picks), populate ward suggestions
        cityInput.addEventListener('input', function(){
            var v = cityInput.value || '';
            wardDatalist.innerHTML = '';
            (wards[v]||[]).forEach(function(w){ var opt = document.createElement('option'); opt.value = w; wardDatalist.appendChild(opt); });
        });

        // coupon
        document.getElementById('applyCouponBtn').addEventListener('click', function(){
            var code = (document.getElementById('couponCode').value||'').trim().toUpperCase();
            if (!code) { document.getElementById('couponMsg').textContent = 'Vui l√≤ng nh·∫≠p m√£.'; return; }
            if (!coupons[code]) { document.getElementById('couponMsg').textContent = 'M√£ kh√¥ng h·ª£p l·ªá.'; appliedCoupon = null; updateSummary(subtotal,0); return; }
            appliedCoupon = { code: code, data: coupons[code] };
            document.getElementById('couponMsg').textContent = '√Åp d·ª•ng m√£ '+code+' th√†nh c√¥ng.';
            updateSummary(subtotal, appliedCoupon);
        });

        // summary initial
        updateSummary(subtotal, appliedCoupon);

        // place order button wiring is handled in updateSummary
    }

    function calcDiscount(sub,total, coupon){
        if (!coupon) return 0;
        var d = 0; if (coupon.data.type === 'percent') d = Math.round(sub * coupon.data.value / 100);
        if (coupon.data.type === 'fixed') d = coupon.data.value; return Math.min(d, sub);
    }

    function updateSummary(subtotal, coupon){
        var sumEl = document.getElementById('checkoutSummary');
        if (!sumEl) return;
        var discount = calcDiscount(subtotal, subtotal, coupon);
        var total = subtotal - discount;
        sumEl.querySelector('.summary-amount').textContent = formatUSD(total);
        // show breakdown
        sumEl.querySelector('.summary-title').textContent = 'Payment Details';
        // create details area
        var details = sumEl.querySelector('.summary-details');
        if (!details){ details = document.createElement('div'); details.className='summary-details'; details.style.fontSize='14px'; details.style.color='#333'; details.style.marginTop='4px'; sumEl.insertBefore(details, sumEl.querySelector('.summary-actions')); }
        details.innerHTML = '<div style="display:flex;justify-content:space-between;color:#666;margin-bottom:6px"><span>T·ªïng ti·ªÅn h√†ng</span><span>'+formatUSD(subtotal)+'</span></div>' +
                            '<div style="display:flex;justify-content:space-between;color:#666;margin-bottom:6px"><span>Discount</span><span>'+(discount?('-'+formatUSD(discount)):'$0')+'</span></div>' +
                            '<div style="height:1px;background:#eee;margin:8px 0"></div>' +
                            '<div style="display:flex;justify-content:space-between;font-weight:700;color:#e74c3c"><span>Total Payment</span><span>'+formatUSD(total)+'</span></div>';

        // update place order button
        var btn = sumEl.querySelector('#placeOrderBtn');
        if (btn){
            btn.textContent = 'Place Order ('+ (getCheckoutItems().length) +')';
            btn.onclick = function(){ submitOrder(subtotal, discount, coupon); };
        }

        // also update small checkout button in other pages if present
        var otherBtn = document.getElementById('checkoutBtn'); if (otherBtn) otherBtn.textContent = 'Mua h√†ng ('+ getCheckoutItems().length +')';
    }

    function validatePhone(phone){ return /^0?\d{9,11}$/.test(phone); }

    function submitOrder(subtotal, discount, coupon){
        // collect fields
        var name = (document.getElementById('customerName')||{}).value || '';
        var phone = (document.getElementById('customerPhone')||{}).value || '';
        var city = (document.getElementById('cityInput')||{}).value || '';
        var ward = (document.getElementById('wardInput')||{}).value || '';
        var addr = (document.getElementById('addressInput')||{}).value || '';
        var note = (document.getElementById('orderNote')||{}).value || '';
        var pay = (document.querySelector('input[name="payMethod"]:checked')||{}).value || '';
        var agree = true; // if there's a checkbox, validate here (omitted in DOM)

        if (!name.trim()) return alert('Vui l√≤ng nh·∫≠p t√™n ng∆∞·ªùi nh·∫≠n.');
        if (!validatePhone(phone)) return alert('Please enter a valid phone number.');
        if (!city) return alert('Vui l√≤ng ch·ªçn t·ªânh/th√†nh ph·ªë.');
        if (!ward) return alert('Vui l√≤ng ch·ªçn ph∆∞·ªùng/x√£.');
        if (!addr.trim()) return alert('Vui l√≤ng nh·∫≠p ƒë·ªãa ch·ªâ nh·∫≠n h√†ng.');
        if (!pay) return alert('Please select a payment method.');

        var items = getCheckoutItems();
        var order = {
            id: 'ORD-' + Date.now(),
            date: new Date().toISOString(),
            items: items,
            customer: { name: name.trim(), phone: phone.trim(), city: city, ward: ward, address: addr.trim() },
            note: note || '',
            payment: pay,
            coupon: coupon ? coupon.code : null,
            subtotal: subtotal,
            discount: discount,
            total: subtotal - discount
        };

        // persist
        var orders = JSON.parse(localStorage.getItem('orders')||'[]'); orders.push(order); localStorage.setItem('orders', JSON.stringify(orders));

        // clear cart
        localStorage.removeItem('checkoutCart'); localStorage.removeItem('cartItems');
        if (window.SITE && SITE.recalcCartCount) SITE.recalcCartCount();

        alert('ƒê·∫∑t h√†ng th√†nh c√¥ng! M√£ ƒë∆°n: ' + order.id);
        window.location.href = 'Trangchu.html';
    }

    document.addEventListener('DOMContentLoaded', function(){
        if (window.SITE && SITE.recalcCartCount) SITE.recalcCartCount();
        renderCheckout();
    });

})();
</script>
</script>

<script>
// Header behaviors: cart count, search, logo and nav wiring
document.addEventListener('DOMContentLoaded', function(){
    var cartIcon = document.getElementById('cartIcon');
    if (window.SITE && SITE.recalcCartCount) SITE.recalcCartCount();
    if (cartIcon) cartIcon.addEventListener('click', function(){ window.location.href = 'Giohangf.html'; });
    var logo = document.getElementById('logo'); if (logo) logo.addEventListener('click', function(){ window.location.href = 'Trangchu.html'; });

    // search
    var searchInput = document.getElementById('siteSearchInput');
    var searchResults = document.getElementById('siteSearchResults');
    function renderSearchResults(results) {
        if (!searchResults) return;
        if (results.length === 0 || !searchInput.value.trim()) { searchResults.style.display = 'none'; searchResults.innerHTML = ''; return; }
        searchResults.innerHTML = results.map(function(p, idx){ return '<div class="search-result-item" data-idx="'+idx+'"><img src="'+p.img+'" style="width:32px;height:32px;object-fit:cover;margin-right:8px;vertical-align:middle">'+p.name+'<span style="float:right;color:#007bff;font-weight:700">$'+((p.price/26306).toFixed(2))+'</span></div>'; }).join('');
        searchResults.style.display = 'block';
    }
    if (searchInput) {
        searchInput.addEventListener('input', function(){ var val = searchInput.value.trim().toLowerCase(); var products = window.SITE && SITE.demoProducts ? SITE.demoProducts : []; var results = products.filter(function(p){ return p.name.toLowerCase().includes(val); }); renderSearchResults(results); });
        document.addEventListener('click', function(e){ if (!searchResults.contains(e.target) && e.target !== searchInput) { searchResults.style.display='none'; } });
        searchResults.addEventListener('click', function(e){ var item = e.target.closest('.search-result-item'); if (item) { var idx = parseInt(item.getAttribute('data-idx')); var products = window.SITE && SITE.demoProducts ? SITE.demoProducts : []; var product = products[idx]; if (product) { localStorage.setItem('currentProduct', JSON.stringify(product)); window.location.href='TheSanpham.html'; } } });
    }

    var allProductsMenu = document.querySelector('nav ul li a[href="TatcaSanpham_en.html"]'); if (allProductsMenu) allProductsMenu.onclick = function(e){ e.preventDefault(); window.location.href='TatcaSanpham_en.html'; };

    var languageSelect = document.getElementById('languageSelect');
    if (languageSelect) {
        languageSelect.addEventListener('change', function() {
            var lang = this.value;
            localStorage.setItem('language', lang);
            if (lang === 'en') {
                window.location.href = 'ThanhToan_en.html';
            } else {
                window.location.href = 'ThanhToan.html';
            }
        });
    }

    // Check stored language and redirect if necessary
    var storedLang = localStorage.getItem('language');
    if (storedLang === 'vi') {
        window.location.href = 'ThanhToan.html';
    }
});
</script>
<script src="assets/js/hamburger.js"></script>

</body>
</html>
